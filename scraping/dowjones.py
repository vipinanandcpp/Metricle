import requests
import gzip
import os, time, datetime, pytz
from dateutil import parser
from bson import json_util

date_format = "%a %b %d %H:%M:%S %Y"
eastern = pytz.timezone('US/Eastern')
utc = pytz.timezone('UTC')

d = utc.localize(datetime.datetime.utcnow()).astimezone(eastern)

sources = {
	424: "Wall Street Journal Interactive Edition - Wall Street Journal Interactive Edition Blog Content",
	425: "The Wall Street Journal Interactive Edition - The Wall Street Journal Interactive Edition Full Story Archive",
	426: "Barrons Online - Barrons Online Full Story Archive for WSJ.com",
	427: "Dow Jones Newswires - Dow Jones Newswires Full Story Archive for WSJ.com"
}

working_directory = os.path.abspath(os.path.dirname(__file__))
data_directory = os.path.join(working_directory, 'data', d.date().strftime('%Y%m%d'))

if not os.path.exists(data_directory):
	os.makedirs(data_directory)

def download_headlines(source=427, count=5000):
	url = lambda source: 'http://betawebapi.dowjones.com/fintech/articles/api/v1/source/%s/?count=%s' % (str(source), str(count))
	results = requests.get(url(source)).json()['Headlines']
	for result in results:
		try:
			result['insertion_date'] = d
			result['creation_date'] = parser.parse( result['CreateTimestamp']['Value'] )
			result['source'] = sources[source]
			result['GUID'] = result['DocumentGuidUri'].split('{')[1].split('}')[0]
		except Exception as e:
			print 'Error: %s -> %s' % (result, e.message)
	with gzip.open(os.path.join(data_directory, 'headlines.json.gz'), 'wb') as f:
		f.write( json_util.dumps(results) )

def download_instruments(ticker, count=4000):
	url = lambda ticker: 'http://betawebapi.dowjones.com/fintech/articles/api/v1/instrument/%s/?count=%s' % (ticker, str(count))
	results = requests.get(url(ticker)).json()
	if 'Headlines' in results:
		results = results['Headlines']
		for result in results:
			try:
				result['insertion_date'] = d
				result['creation_date'] = parser.parse( result['CreateTimestamp']['Value'] )
				result['GUID'] = result['DocumentGuidUri'].split('{')[1].split('}')[0]
			except Exception as e:
				print 'Error: %s -> %s' % (result, e.message)
		with gzip.open( os.path.join(data_directory, 'headlines_' + ticker + '.json.gz'), 'wb') as f:
			f.write( json_util.dumps(results) )

def runner(tickers, snooze=10):
	download_headlines()
	for ticker in tickers:
		try:
			print 'downloading %s' % ticker
			download_instruments(ticker)
		except Exception as e:
			print 'Error: ticker -> %s' % e.message
		finally:
			time.sleep(snooze)

#tickers = ['A','AA','AAN','AAP','AAPL','AAWW','AB','ABB','ABBV','ABC','ABFS','ABG','ABMD','ABT','ABV','ABX','ACAD','ACAS','ACC','ACCO','ACE','ACGL','ACHN','ACI','ACIW','ACM','ACN','ACOR','ACT','ACTG','ACTV','ACWI','ACXM','ADBE','ADI','ADM','ADP','ADS','ADSK','ADT','ADTN','AEC','AEE','AEG','AEGR','AEIS','AEL','AEM','AEO','AEP','AER','AES','AET','AF','AFFX','AFG','AFL','AG','AGCO','AGG','AGN','AGNC','AGO','AGQ','AGU','AH','AHL','AHT','AIG','AINV','AIR','AIV','AIZ','AJG','AKAM','AKRX','AKS','AL','ALB','ALGN','ALJ','ALK','ALKS','ALL','ALLT','ALNY','ALR','ALSK','ALTR','ALU','ALV','ALXN','AMAT','AMCC','AMCX','AMD','AME','AMED','AMG','AMGN','AMJ','AMKR','AMLP','AMP','AMRN','AMSC','AMT','AMTD','AMTG','AMX','AMZN','AN','ANF','ANGI','ANH','ANN','ANR','ANSS','ANV','AOD','AOL','AON','AOS','APA','APC','APD','APH','APL','APO','APOL','ARAY','ARCC','ARCO','ARCP','ARE','AREX','ARG','ARIA','ARMH','ARNA','ARO','ARQL','ARR','ARRS','ARRY','ARUN','ARW','ASBC','ASH','ASML','ASNA','ASTX','ASX','AT','ATHN','ATI','ATK','ATML','ATO','ATRS','ATU','ATVI','ATW','AU','AUO','AUQ','AUXL','AUY','AVA','AVB','AVEO','AVG','AVGO','AVNR','AVP','AVT','AVY','AWAY','AWI','AWK','AXAS','AXE','AXL','AXLL','AXP','AXS','AYI','AYR','AZN','AZO','AZPN','B','BA','BAC','BAH','BAK','BAM','BAP','BAS','BAX','BBBY','BBD','BBEP','BBG','BBL','BBRY','BBT','BBVA','BBY','BC','BCE','BCEI','BCR','BCRX','BCS','BDC','BDN','BDX','BEAM','BEAV','BEBE','BECN','BEE','BEN','BG','BGC','BGCP','BGG','BGS','BHI','BHP','BID','BIDU','BIG','BIIB','BIOS','BJRI','BK','BKCC','BKD','BKE','BKS','BKU','BKW','BLC','BLK','BLL','BLOX','BMO','BMR','BMRN','BMS','BMY','BND','BNS','BOH','BP','BPFH','BPI','BPL','BPO','BPOP','BPZ','BR','BRCD','BRCM','BRE','BRFS','BRKR','BRLI','BRO','BRY','BSBR','BSFT','BSMX','BSV','BSX','BTU','BUD','BV','BVN','BWA','BWC','BWLD','BWP','BWS','BX','BXP','BXS','BYD','BYI','BZ','BZH','C','CA','CAB','CACI','CAG','CAH','CAJ','CAKE','CALX','CAM','CAR','CAT','CATY','CAVM','CB','CBB','CBD','CBG','CBI','CBL','CBOE','CBS','CBSH','CBST','CBT','CCC','CCE','CCI','CCJ','CCK','CCL','CCOI','CDE','CDNS','CE','CECO','CEF','CELG','CENX','CERN','CETV','CF','CFFN','CFN','CFR','CFX','CHD','CHK','CHKP','CHL','CHMT','CHRW','CHS','CHTP','CHTR','CHU','CI','CIB','CIE','CIEN','CIG','CIM','CINF','CIT','CJES','CL','CLB','CLD','CLDX','CLF','CLGX','CLH','CLI','CLMT','CLNE','CLNY','CLP','CLR','CLS','CLSN','CLX','CMA','CMC','CME','CMG','CMI','CMO','CMS','CNC','CNI','CNK','CNL','CNO','CNP','CNQ','CNQR','CNW','CNX','COCO','CODE','COF','COG','COH','COL','COLE','CONN','COO','COP','COST','COT','COV','CP','CPA','CPB','CPHD','CPL','CPN','CPRT','CPST','CPT','CPWR','CQB','CR','CREE','CRI','CRIS','CRK','CRL','CRM','CROX','CRR','CRS','CRUS','CRZO','CS','CSC','CSCO','CSE','CSIQ','CSJ','CSL','CSOD','CSX','CTAS','CTB','CTCM','CTCT','CTIC','CTL','CTRP','CTRX','CTSH','CTXS','CUBE','CUZ','CVA','CVBF','CVC','CVD','CVE','CVG','CVI','CVLT','CVO','CVS','CVX','CWH','CX','CXO','CXW','CY','CYBX','CYH','CYN','CYS','CYT','CZR','CZZ','D','DAL','DAN','DANG','DAR','DB','DBA','DBC','DBD','DCI','DCT','DCTH','DD','DDD','DDM','DDR','DDS','DE','DECK','DEI','DELL','DEM','DENN','DEO','DEPO','DF','DFS','DFT','DG','DGI','DGIT','DGX','DHI','DHR','DHX','DIA','DIG','DIS','DISH','DK','DKS','DLB','DLLR','DLPH','DLR','DLTR','DLX','DMD','DMND','DNB','DNDN','DNKN','DNR','DO','DOLE','DOV','DOW','DOX','DPS','DPZ','DRC','DRE','DRH','DRI','DRIV','DRQ','DRYS','DSW','DSX','DTE','DTV','DUG','DUK','DUST','DV','DVA','DVAX','DVN','DVR','DVY','DWA','DXCM','DXD','DXJ','DY','DYAX','DYN','E','EA','EAT','EBAY','EBIX','EBR','EC','ECA','ECL','ED','EDC','EDR','EDU','EDZ','EEM','EEP','EFA','EFX','EGHT','EGN','EGO','EGY','EIX','EL','ELGX','ELLI','ELN','ELNK','ELP','ELX','ELY','EMB','EMC','EME','EMN','EMR','ENB','END','ENDP','ENH','ENI','ENR','ENS','ENTG','ENTR','EOG','EPB','EPD','EPI','EPP','EQIX','EQR','EQT','EQY','ERF','ERIC','ERJ','ERX','ERY','ESI','ESRX','ESS','ESV','ETE','ETFC','ETH','ETN','ETP','ETR','EUO','EV','EVEP','EVER','EVR','EW','EWA','EWBC','EWC','EWG','EWH','EWI','EWJ','EWM','EWS','EWT','EWU','EWW','EWY','EWZ','EXAS','EXC','EXEL','EXG','EXH','EXK','EXP','EXPD','EXPE','EXPR','EXR','EXTR','EXXI','EZCH','EZPW','EZU','F','FAF','FAS','FAST','FAX','FAZ','FB','FBC','FBHS','FBR','FCEL','FCF','FCH','FCN','FCS','FCX','FDO','FDS','FDX','FE','FEIC','FFIV','FHN','FIG','FII','FINL','FIO','FIRE','FIS','FISV','FITB','FL','FLEX','FLIR','FLO','FLR','FLS','FLT','FMBI','FMC','FMER','FMX','FNB','FNF','FNFG','FNP','FNSR','FNV','FOE','FORM','FOSL','FOXA','FR','FRAN','FRC','FRO','FRT','FRX','FSC','FSL','FSLR','FST','FTI','FTK','FTNT','FTR','FUL','FULT','FWLT','FXE','FXI','G','GA','GALE','GAME','GAS','GBCI','GBX','GCA','GCI','GCO','GD','GDOT','GDP','GDX','GDXJ','GE','GEO','GERN','GES','GFA','GFI','GG','GGB','GGG','GGP','GHL','GIL','GILD','GIS','GLD','GLDD','GLNG','GLUU','GLW','GM','GMCR','GME','GMT','GNC','GNK','GNRC','GNTX','GNW','GOL','GOLD','GOOG','GOV','GPC','GPI','GPK','GPN','GPOR','GPRE','GPS','GRA','GRFS','GRMN','GRPN','GRT','GS','GSK','GSM','GSS','GT','GTAT','GTE','GTI','GTIV','GTLS','GWR','GWRE','GWW','GXP','GY','H','HA','HAIN','HAL','HALO','HAR','HAS','HBAN','HBC','HBHC','HBI','HCA','HCBK','HCC','HCN','HCP','HCSG','HD','HDB','HDY','HE','HERO','HES','HFC','HGG','HIBB','HIG','HIMX','HIW','HK','HL','HLF','HLIT','HLS','HLSS','HLX','HMA','HMC','HME','HMIN','HMSY','HMY','HNR','HNT','HOG','HOLX','HON','HOS','HOT','HOV','HP','HPQ','HPT','HPY','HR','HRB','HRC','HRL','HRS','HSC','HSH','HSIC','HSNI','HSP','HST','HSY','HT','HTA','HTLD','HTS','HTZ','HUM','HUN','HW','HXL','HXM','HYG','IACI','IAG','IAU','IBB','IBKR','IBM','IBN','ICE','ICF','ICON','IDCC','IDIX','IDTI','IDXX','IEF','IEX','IFF','IGT','IHS','IJH','IJR','IL','ILF','ILMN','IM','IMAX','IMGN','IMO','INCY','INFA','INFI','INFN','INFY','ING','INGR','INO','INT','INTC','INTU','INVN','INXN','IO','IOC','IP','IPG','IPGP','IPI','IPXL','IQNT','IR','IRBT','IRC','IRDM','IRE','IRF','IRM','IRWD','ISIL','ISIS','ISRG','IT','ITB','ITC','ITG','ITMN','ITRI','ITT','ITUB','ITW','IVR','IVV','IVW','IVZ','IWB','IWD','IWF','IWM','IWN','IWO','IWS','IYR','IYT','JACK','JAH','JASO','JAZZ','JBHT','JBL','JBLU','JCI','JCOM','JCP','JDSU','JEC','JIVE','JKHY','JLL','JMBA','JNJ','JNK','JNPR','JNS','JNY','JOE','JOSB','JOY','JPM','JRCC','JWN','K','KAR','KBE','KBH','KBR','KCG','KEG','KEP','KERX','KEX','KEY','KFN','KGC','KIM','KKD','KKR','KLAC','KLIC','KMB','KMI','KMP','KMR','KMT','KMX','KND','KNX','KO','KOG','KORS','KOS','KR','KRA','KRC','KRE','KRFT','KRO','KSS','KSU','KT','KWK','L','LAD','LAMR','LAZ','LCC','LDK','LEA','LEAP','LECO','LEG','LEN','LF','LFC','LFL','LGF','LH','LHO','LIFE','LII','LINE','LKQ','LL','LLL','LLNW','LLTC','LLY','LM','LMCA','LMT','LNC','LNCO','LNG','LNKD','LNT','LO','LOGI','LOGM','LOPE','LOW','LPI','LPL','LPLA','LPNT','LPS','LPSN','LPX','LQD','LQDT','LRCX','LRN','LRY','LSCC','LSI','LSTR','LTD','LTM','LUK','LULU','LUV','LVLT','LVS','LXK','LXP','LXRX','LYB','LYG','LYV','LZB','M','MA','MAA','MAC','MAKO','MAN','MAR','MAS','MASI','MAT','MBI','MBT','MCD','MCHP','MCK','MCO','MCP','MCRS','MD','MDAS','MDC','MDCO','MDLZ','MDP','MDR','MDRX','MDT','MDU','MDVN','MDY','MELI','MENT','MEOH','MET','MFA','MFC','MGA','MGM','MHK','MHR','MITK','MJN','MKC','MKTG','MLHR','MLM','MLNX','MM','MMC','MMM','MMP','MNKD','MNRO','MNST','MNTA','MO','MOH','MOLX','MON','MOO','MOS','MPC','MPEL','MPW','MPWR','MR','MRC','MRGE','MRH','MRK','MRO','MRVL','MS','MSCC','MSCI','MSFT','MSG','MSI','MSM','MT','MTB','MTG','MTGE','MTH','MTL','MTN','MTOR','MTU','MTW','MTZ','MU','MUR','MUX','MW','MWA','MWE','MWV','MWW','MXIM','MYGN','MYL','N','NAT','NATI','NAV','NAVB','NBG','NBIX','NBL','NBR','NCR','NCT','NDAQ','NDSN','NE','NEE','NEM','NFG','NFLX','NFX','NG','NGD','NGG','NGLS','NI','NIHD','NKE','NKTR','NLSN','NLY','NNN','NOC','NOG','NOK','NOR','NOV','NOW','NPBC','NPSP','NQ','NR','NRF','NRG','NRGY','NRZ','NSC','NSM','NSR','NSU','NTAP','NTE','NTES','NTGR','NTI','NTRI','NTRS','NU','NUAN','NUE','NUGT','NUS','NUVA','NVAX','NVDA','NVE','NVO','NVS','NWBI','NWL','NWS','NWSA','NX','NXPI','NXTM','NYCB','NYMT','NYT','NYX','O','OAS','OC','OCLR','OCN','OCR','OCZ','ODFL','ODP','OEF','OEH','OFC','OGE','OHI','OI','OIBR','OIH','OII','OIS','OKE','OKS','OLN','OMC','OMEX','OMI','OMX','ONB','ONE','ONNN','ONTY','OPEN','OPK','OPTR','ORCL','OREX','ORI','ORLY','OSK','OSUR','OTEX','OVTI','OWW','OXY','OZM','P','PAA','PAAS','PAG','PAL','PANW','PAY','PAYX','PBCT','PBF','PBH','PBI','PBR','PBY','PCAR','PCG','PCL','PCLN','PCP','PCY','PCYC','PDCE','PDCO','PDLI','PDM','PDS','PEB','PEG','PEI','PEIX','PENN','PEP','PETM','PFE','PFF','PFG','PG','PGH','PGR','PH','PHG','PHH','PHM','PHYS','PII','PIR','PKD','PKG','PKI','PL','PLAB','PLCE','PLCM','PLD','PLL','PLXT','PM','PMCS','PMT','PMTC','PNC','PNK','PNM','PNNT','PNR','PNRA','PNW','PNY','PODD','POL','POM','POR','POT','PPC','PPG','PPHM','PPL','PPO','PPS','PQ','PRE','PRGO','PRGS','PRKR','PRU','PRXL','PSA','PSEC','PSLV','PSUN','PSX','PTEN','PVA','PVH','PVR','PVTB','PWE','PWR','PWRD','PX','PXD','PZG','QCOM','QCOR','QEP','QGEN','QID','QIHU','QLD','QLGC','QLIK','QQQ','QSII','QTM','R','RAD','RAI','RAS','RATE','RAX','RBA','RBC','RBCN','RBS','RBY','RCI','RCII','RCL','RDC','RDN','RE','REE','REG','REGN','REN','RENN','RES','REXX','RF','RFMD','RGA','RGC','RGLD','RGP','RGR','RGS','RHI','RHP','RHT','RIG','RIGL','RIO','RJET','RJF','RKT','RKUS','RL','RLD','RLGY','RLJ','RMBS','RMD','RNR','ROC','ROIC','ROK','ROP','ROSE','ROST','ROVI','RP','RPAI','RPM','RPRX','RPTP','RRC','RRD','RS','RSG','RSH','RSO','RSP','RSX','RT','RTI','RTK','RTN','RUE','RVBD','RWM','RWT','RY','RYL','RYN','S','SA','SAFM','SAH','SAN','SANM','SAP','SAPE','SAVE','SBAC','SBGI','SBH','SBNY','SBS','SBUX','SCCO','SCG','SCHN','SCHW','SCI','SCLN','SCO','SCS','SCSS','SCTY','SD','SDRL','SDS','SDY','SE','SEE','SEIC','SEM','SEMG','SF','SFI','SFL','SFLY','SFUN','SFY','SGEN','SGI','SGMO','SGMS','SGY','SH','SHFL','SHLD','SHO','SHOO','SHW','SI','SIAL','SID','SIG','SIMG','SIMO','SINA','SIRI','SIRO','SIVB','SIX','SJM','SKF','SKM','SKS','SKT','SKUL','SKX','SKYW','SLAB','SLB','SLCA','SLF','SLG','SLH','SLM','SLV','SLW','SLXP','SM','SMFG','SMG','SMH','SMTC','SNA','SNCR','SNDK','SNE','SNH','SNI','SNPS','SNTA','SNTS','SNV','SNY','SO','SODA','SOHU','SOL','SON','SONC','SONS','SPF','SPG','SPIL','SPLK','SPLS','SPN','SPPI','SPR','SPRD','SPW','SPWR','SPXL','SPXS','SPXU','SPY','SQM','SQNM','SQQQ','SRC','SRCL','SRE','SREV','SRPT','SRTY','SSI','SSO','SSRI','SSYS','ST','STE','STEI','STI','STJ','STLD','STM','STNG','STO','STP','STR','STSI','STT','STWD','STX','STZ','SU','SUNE','SUSQ','SVM','SVNT','SVU','SVXY','SWC','SWFT','SWHC','SWI','SWK','SWKS','SWN','SWY','SXC','SYA','SYK','SYMC','SYNA','SYY','SZYM','T','TAL','TAP','TASR','TBT','TC','TCB','TCBI','TCK','TCO','TD','TDC','TDG','TDS','TDW','TE','TECD','TEF','TEG','TEL','TEN','TER','TEVA','TEX','TFM','TGI','TGT','THC','THI','THLD','THO','THOR','THRX','TIBX','TIF','TIP','TITN','TIVO','TJX','TK','TKC','TKR','TLAB','TLM','TLT','TM','TMH','TMK','TMO','TMUS','TMV','TNA','TNGO','TNK','TOL','TOT','TPLM','TPX','TQNT','TQQQ','TRI','TRIP','TRMB','TRMK','TRN','TROW','TROX','TRP','TRQ','TRV','TRW','TRX','TS','TSCO','TSL','TSLA','TSM','TSN','TSO','TSRA','TSS','TSU','TTEK','TTI','TTM','TTMI','TTWO','TUMI','TUP','TV','TVIX','TW','TWC','TWGP','TWI','TWM','TWO','TWTC','TWX','TX','TXI','TXN','TXRH','TXT','TYC','TZA','UA','UAL','UBNT','UBS','UCO','UDR','UEC','UFS','UGI','UGP','UHS','UIS','UL','ULTA','UMC','UMPQ','UN','UNFI','UNG','UNH','UNIS','UNM','UNP','UNT','UNTD','UNXL','UPL','UPRO','UPS','URBN','URI','URS','URTY','USB','USG','USO','USU','UTHR','UTIW','UTX','UUP','UVXY','UWM','UYG','UYM','V','VAL','VALE','VAR','VC','VCI','VCLK','VE','VEA','VECO','VELT','VEU','VFC','VG','VGK','VGR','VGZ','VHC','VIAB','VICL','VIG','VIP','VIV','VIXY','VLO','VLTR','VLY','VMC','VMW','VNO','VNQ','VNTV','VOD','VOLC','VOO','VPHM','VPRT','VR','VRA','VRNG','VRSK','VRSN','VRTX','VRX','VSH','VSI','VTG','VTI','VTR','VUG','VVC','VVUS','VWO','VXX','VZ','WAB','WAC','WAFD','WAG','WAL','WAT','WBC','WBMD','WBS','WCC','WCG','WCN','WDAY','WDC','WDR','WEC','WEN','WERN','WETF','WFC','WFM','WFT','WG','WHR','WIN','WIT','WLK','WLL','WLP','WLT','WM','WMB','WMC','WMGI','WMS','WMT','WNC','WNR','WOOF','WOR','WPRT','WPX','WPZ','WR','WRB','WRE','WRI','WSH','WSM','WTI','WTR','WTW','WU','WWAV','WWD','WWW','WWWW','WY','WYN','WYNN','X','XCO','XEC','XEL','XHB','XIV','XL','XLB','XLE','XLF','XLI','XLK','XLNX','XLP','XLS','XLU','XLV','XLY','XME','XNPT','XOM','XOMA','XOP','XRAY','XRT','XRX','XXIA','XYL','YELP','YGE','YHOO','YNDX','YOKU','YPF','YUM','Z','ZAGG','ZINC','ZION','ZIOP','ZLC','ZMH','ZNGA','ZQK','ZSL','ZTS','ZUMZ']
